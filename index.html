<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SPPG v9.4 Stable Core</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: { dark: '#050505', card: '#121212', accent: '#8b5cf6', danger: '#ef4444' },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out', 'slide-up': 'slideUp 0.3s ease-out', 'pulse-red': 'pulseRed 2s infinite' },
                    keyframes: { 
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        pulseRed: { '0%, 100%': { boxShadow: '0 0 0 0 rgba(239, 68, 68, 0.7)' }, '50%': { boxShadow: '0 0 0 10px rgba(239, 68, 68, 0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #050505; color: #fff; -webkit-tap-highlight-color: transparent; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .glass-panel { background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        .spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s ease-in-out infinite; }
        
        /* Custom Date Picker Dark Mode */
        input[type="date"] { color-scheme: dark; }
        
        @keyframes spin { to { transform: rotate(360deg); } }

        /* PRINT STYLES */
        .print-container {
            background: white;
            color: black;
            width: 210mm;
            min-height: 297mm; 
            padding: 20mm 15mm;
            font-family: Arial, sans-serif;
            box-sizing: border-box;
            position: relative;
            overflow: hidden; 
        }
        .report-wrapper {
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 20px;
        }
        .report-item {
            box-sizing: border-box;
            background: #fff;
            margin-bottom: 20px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, memo, useCallback } = React;

        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1000;
                        const scale = MAX_WIDTH / img.width;
                        const finalScale = scale >= 1 ? 1 : scale;
                        canvas.width = img.width * finalScale;
                        canvas.height = img.height * finalScale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                };
            });
        };

        const Icon = ({ name, className="" }) => <i className={`fas fa-${name} ${className}`}></i>;

        // --- COMPONENTS DEFINED OUTSIDE APP (STABILITY FIX) ---

        const OverflowModal = ({ show, items, onDelete, onReset, currentHeight, limit }) => {
            if (!show) return null;
            const diff = currentHeight - limit;
            return (
                <div className="fixed inset-0 z-[999] bg-black/90 backdrop-blur-xl flex flex-col items-center justify-center p-6 animate-fade-in">
                    <div className="bg-[#1a1a1a] border-2 border-red-500 w-full max-w-lg rounded-3xl p-6 shadow-[0_0_50px_rgba(239,68,68,0.3)] relative overflow-hidden">
                        <div className="flex flex-col items-center text-center mb-6">
                            <div className="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mb-4 animate-pulse-red">
                                <Icon name="exclamation-triangle" className="text-3xl text-red-500" />
                            </div>
                            <h2 className="text-2xl font-black text-white uppercase tracking-tighter">HALAMAN PENUH!</h2>
                            <p className="text-red-400 font-medium text-sm mt-2">Konten melebihi 1 kertas A4.</p>
                        </div>
                        <div className="space-y-4">
                            <div className="max-h-[30vh] overflow-y-auto space-y-2 pr-2">
                                {items.map((item, idx) => (
                                    <div key={item.id} className="flex items-center justify-between bg-zinc-900 p-2 rounded-xl border border-zinc-800">
                                        <div className="flex items-center gap-3">
                                            <img src={item.img} className="w-10 h-10 rounded-lg object-cover bg-black" />
                                            <span className="text-xs font-bold text-zinc-300">Img #{idx+1}</span>
                                        </div>
                                        <button onClick={() => onDelete(item.id)} className="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-xs font-bold transition-colors">HAPUS</button>
                                    </div>
                                ))}
                            </div>
                            <div className="pt-4 border-t border-zinc-800">
                                <button onClick={onReset} className="w-full py-3 bg-red-500/10 border border-red-500/50 text-red-500 rounded-xl text-sm font-bold hover:bg-red-500 hover:text-white transition-all">RESET SEMUA</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ImageCard = memo(({ item, index, onDelete, onUpdateText }) => {
            const [localText, setLocalText] = useState(item.text);
            useEffect(() => { setLocalText(item.text); }, [item.text]);
            const handleBlur = () => { if (localText !== item.text) onUpdateText(item.id, localText); };
            return (
                <div className="bg-[#121212] rounded-[1.5rem] border border-white/5 overflow-hidden">
                    <div className="relative aspect-video bg-black">
                        <img src={item.img} className="w-full h-full object-contain" />
                        <button onClick={() => onDelete(item.id)} className="absolute top-2 right-2 w-8 h-8 rounded-full bg-red-500/20 text-red-500 flex items-center justify-center backdrop-blur-md"><Icon name="times" /></button>
                    </div>
                    <div className="p-4">
                        <div className="text-[9px] font-bold text-zinc-500 mb-2 uppercase">IMG #{index + 1}</div>
                        <textarea value={localText} onChange={(e) => setLocalText(e.target.value)} onBlur={handleBlur} placeholder="Keterangan..." className="w-full bg-zinc-900 rounded-xl p-3 text-sm text-white border border-white/5 resize-none h-20 focus:outline-none focus:border-accent" />
                    </div>
                </div>
            );
        });

        // Report Content (Dipisah biar bisa dipanggil ulang)
        const ReportContent = ({ config, items }) => {
            const widthPercent = config.cols === 1 ? '100%' : config.cols === 2 ? '48%' : '32%';
            
            const getFormattedDate = () => {
                if (!config.date) return "";
                const options = { day: 'numeric', month: 'long', year: 'numeric' };
                return new Date(config.date).toLocaleDateString('id-ID', options);
            };

            return (
                <div className="print-container">
                    <div style={{ borderBottom: '4px solid black', paddingBottom: '20px', marginBottom: '30px', display: 'flex', justifyContent: 'space-between', alignItems: 'flex-end' }}>
                        <div style={{ maxWidth: '60%' }}>
                            <h1 style={{ fontSize: '24px', fontWeight: '900', textTransform: 'uppercase', lineHeight: '1.2', margin: 0 }}>{config.title}</h1>
                            <p style={{ fontSize: '10pt', fontWeight: 'bold', color: '#666', letterSpacing: '2px', textTransform: 'uppercase', marginTop: '5px' }}>OFFICIAL DOCUMENTATION</p>
                        </div>
                        <div style={{ textAlign: 'right' }}>
                            <div style={{ fontSize: '12pt', fontWeight: 'bold', textTransform: 'uppercase' }}>{config.author}</div>
                            <div style={{ fontSize: '10pt', color: '#666' }}>{getFormattedDate()}</div>
                        </div>
                    </div>

                    <div className="report-wrapper">
                        {items.map((item, i) => {
                            const hasDesc = item.text && item.text.trim().length > 0;
                            return (
                                <div key={item.id} className="report-item" style={{ width: widthPercent, border: '1px solid #eee', padding: '5px', display: 'block' }}>
                                    <div style={{ width: '100%', height: config.cols === 1 ? 'auto' : '200px', backgroundColor: '#f8f9fa', display: 'flex', alignItems: 'center', justifyContent: 'center', overflow: 'hidden' }}>
                                        <img src={item.img} style={{ maxWidth: '100%', maxHeight: config.cols === 1 ? '600px' : '200px', objectFit: 'contain' }} />
                                    </div>
                                    {hasDesc && (
                                        <div style={{ marginTop: '10px', padding: '5px' }}>
                                            <div style={{ fontSize: '10pt', fontWeight: '600', color: '#000', lineHeight: '1.4', whiteSpace: 'pre-wrap', overflowWrap: 'break-word', wordWrap: 'break-word', wordBreak: 'break-word', width: '100%' }}>
                                                {item.text}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // Views Defined Outside App (Fixes Focus Bug)
        const EditorView = ({ items, onReset, onDelete, onUpdateText }) => {
            if (items.length === 0) {
                return (
                    <div className="pb-32 animate-fade-in">
                        <div className="h-[60vh] flex flex-col items-center justify-center opacity-40"><Icon name="camera" className="text-4xl mb-4" /><p>Mulai Upload Foto</p></div>
                    </div>
                );
            }
            return (
                <div className="pb-32 animate-fade-in space-y-6">
                    <div className="flex justify-between items-center px-2">
                        <span className="text-[10px] font-black uppercase tracking-widest text-zinc-500">{items.length} FILES</span>
                        <button onClick={onReset} className="text-[10px] font-bold text-red-500">RESET</button>
                    </div>
                    {items.map((item, idx) => (<ImageCard key={item.id} item={item} index={idx} onDelete={onDelete} onUpdateText={onUpdateText} />))}
                </div>
            );
        };

        const PreviewView = ({ config, items, handleDownload, isExporting }) => (
            <div className="pb-32 bg-[#050505] min-h-screen animate-fade-in">
                <div className="sticky top-24 z-10 px-4 mb-6">
                    <div className="glass-panel p-3 rounded-2xl flex justify-between items-center shadow-2xl">
                        <span className="text-xs font-bold pl-2 flex items-center gap-2"><Icon name="eye" /> Live Preview</span>
                        <button onClick={handleDownload} disabled={isExporting} className="bg-white text-black px-4 py-2 rounded-xl text-xs font-bold shadow-lg flex items-center gap-2">
                            {isExporting ? <div className="spinner border-zinc-400 border-t-black"></div> : <Icon name="download" />}
                            {isExporting ? 'Proses...' : 'Save PDF'}
                        </button>
                    </div>
                </div>
                <div className="overflow-x-auto px-4 pb-10">
                    <div className="mx-auto shadow-2xl origin-top-left scale-[0.45] sm:scale-100 mb-[-150mm] sm:mb-0 rounded-sm" style={{ width: '210mm' }}><ReportContent config={config} items={items} /></div>
                </div>
            </div>
        );

        const SettingsView = ({ config, setConfig, onReset }) => (
            <div className="p-4 space-y-4 animate-fade-in pb-32">
                <h2 className="text-xl font-bold px-2">Settings</h2>
                <div className="bg-[#121212] p-5 rounded-[1.5rem] border border-white/5 space-y-4">
                    <div className="space-y-1"><label className="text-[10px] font-bold text-zinc-500 uppercase ml-2">Judul</label><input type="text" value={config.title} onChange={e => setConfig({...config, title: e.target.value})} className="w-full bg-black/50 border border-white/10 rounded-xl p-3 text-sm text-white focus:border-accent outline-none" /></div>
                    <div className="space-y-1"><label className="text-[10px] font-bold text-zinc-500 uppercase ml-2">Nama</label><input type="text" value={config.author} onChange={e => setConfig({...config, author: e.target.value})} className="w-full bg-black/50 border border-white/10 rounded-xl p-3 text-sm text-white focus:border-accent outline-none" /></div>
                    <div className="space-y-1"><label className="text-[10px] font-bold text-zinc-500 uppercase ml-2">Tanggal</label><input type="date" value={config.date} onChange={e => setConfig({...config, date: e.target.value})} className="w-full bg-black/50 border border-white/10 rounded-xl p-3 text-sm text-white focus:border-accent outline-none appearance-none" /></div>
                    <div className="space-y-2"><label className="text-[10px] font-bold text-zinc-500 uppercase ml-2">Layout</label><div className="flex bg-black/50 rounded-xl p-1 border border-white/10">{[1, 2, 3].map(n => (<button key={n} onClick={() => setConfig({...config, cols: n})} className={`flex-1 py-3 rounded-lg text-xs font-bold transition-all ${config.cols === n ? 'bg-white text-black shadow-lg' : 'text-zinc-500'}`}>{n} COL</button>))}</div></div>
                </div>
                <button onClick={onReset} className="w-full py-4 bg-red-500/10 border border-red-500/50 text-red-500 rounded-2xl font-bold flex items-center justify-center gap-2 hover:bg-red-500 hover:text-white transition-all"><Icon name="trash" /> RESET SEMUA DATA</button>
            </div>
        );

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState('editor'); 
            const [items, setItems] = useState([]);
            const [loading, setLoading] = useState(false);
            const [isExporting, setIsExporting] = useState(false);
            const [isOverflow, setIsOverflow] = useState(false);
            const [currentHeight, setCurrentHeight] = useState(0);
            const [toast, setToast] = useState({ show: false, message: '' });
            
            const [config, setConfig] = useState({
                title: 'LAPORAN OPERASIONAL',
                author: 'Bro Fadlan',
                date: new Date().toISOString().split('T')[0],
                cols: 2
            });

            const LIMIT_HEIGHT = 1200; 
            const fileInputRef = useRef(null);

            useEffect(() => {
                if (items.length === 0) { setIsOverflow(false); return; }
                const measureDiv = document.getElementById('measure-area');
                if (measureDiv) {
                    setTimeout(() => {
                        const height = measureDiv.scrollHeight;
                        setCurrentHeight(height);
                        if (height > LIMIT_HEIGHT) setIsOverflow(true);
                        else setIsOverflow(false);
                    }, 500);
                }
            }, [items, config]); 

            const handleFile = async (e) => {
                if(isOverflow) return alert("Halaman Penuh! Hapus gambar dulu.");
                const files = e.target.files;
                if (!files || files.length === 0) return;
                setLoading(true);
                const newItems = [];
                for (let i = 0; i < files.length; i++) {
                    try {
                        const img = await compressImage(files[i]);
                        newItems.push({ id: Date.now() + Math.random(), img, text: '' });
                    } catch(e){}
                }
                setItems(prev => [...prev, ...newItems]);
                setLoading(false);
                e.target.value = null;
            };

            const updateItemText = (id, newText) => {
                setItems(prevItems => prevItems.map(item => item.id === id ? { ...item, text: newText } : item));
            };

            const deleteItem = (id) => { setItems(prev => prev.filter(i => i.id !== id)); };
            const handleReset = () => { 
                if(confirm("Yakin RESET DATA?")) {
                    setItems([]); setIsOverflow(false); 
                }
            };
            
            // Versi reset tanpa confirm (untuk tombol di overflow modal)
            const handleForceReset = () => {
                setItems([]); setIsOverflow(false); 
            };

            const handleDownload = async () => {
                if (isOverflow) return alert("Konten melebihi 1 halaman!");
                if (items.length === 0) return alert("Foto kosong!");
                setIsExporting(true);
                const element = document.getElementById('phantom-print-area');
                element.style.display = 'block';
                const opt = {
                    margin: 0, 
                    filename: `SPPG_REPORT.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                try {
                    await html2pdf().set(opt).from(element).save();
                    setToast({show: true, message: "PDF Berhasil!"});
                    setTimeout(() => setToast({show:false, message:''}), 3000);
                } catch (e) { alert("Error PDF"); }
                element.style.display = 'none';
                setIsExporting(false);
            };

            return (
                <div className="min-h-screen bg-[#050505] font-sans pb-safe-bottom text-white selection:bg-accent selection:text-white">
                    {toast.show && ( <div className="fixed top-6 left-0 right-0 z-[100] flex justify-center animate-slide-up pointer-events-none"><div className="bg-zinc-800 border border-zinc-700 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 backdrop-blur-md"><Icon name="check-circle" className="text-green-400" /><span className="font-bold text-xs tracking-wide">{toast.message}</span></div></div> )}
                    <OverflowModal show={isOverflow} items={items} onDelete={deleteItem} onReset={handleForceReset} currentHeight={currentHeight} limit={LIMIT_HEIGHT} />
                    
                    {/* Measurement & Phantom Print Areas */}
                    <div id="measure-area" style={{ position: 'absolute', top: -9999, left: -9999, width: '210mm', visibility: 'hidden', height: 'auto', overflow: 'visible' }}><ReportContent config={config} items={items} /></div>
                    <div id="phantom-print-area" style={{ display: 'none' }}><ReportContent config={config} items={items} /></div>
                    
                    {loading && <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex flex-col items-center justify-center"><div className="spinner mb-4 border-t-accent w-10 h-10"></div><span className="text-xs font-bold animate-pulse">Mengompres Foto...</span></div>}
                    
                    <div className="fixed top-0 left-0 right-0 z-40 px-6 py-5 glass-panel flex justify-between items-center shadow-2xl">
                        <div className="flex items-center gap-3"><div className="w-9 h-9 rounded-xl bg-gradient-to-tr from-violet-600 to-indigo-600 flex items-center justify-center text-white shadow-[0_0_20px_rgba(139,92,246,0.5)]"><Icon name="bolt" /></div><div><h1 className="font-bold tracking-tight text-lg leading-none">SPPG<span className="text-zinc-600">.CORE</span></h1><p className="text-[9px] text-zinc-500 font-mono">v9.4 STABLE</p></div></div>
                    </div>
                    
                    <div className="pt-24 px-4 max-w-2xl mx-auto min-h-screen">
                        {view === 'editor' && <EditorView items={items} onReset={() => { if(confirm("Hapus semua?")) handleForceReset() }} onDelete={deleteItem} onUpdateText={updateItemText} />}
                        {view === 'preview' && <PreviewView config={config} items={items} handleDownload={handleDownload} isExporting={isExporting} />}
                        {view === 'settings' && <SettingsView config={config} setConfig={setConfig} onReset={handleReset} />}
                    </div>
                    
                    <div className="fixed bottom-8 left-0 right-0 z-50 flex justify-center pointer-events-none">
                        <div className="pointer-events-auto glass-panel rounded-[2.5rem] p-2 flex items-center gap-2 shadow-2xl border border-white/10 bg-black/60 backdrop-blur-xl">
                            <button onClick={() => setView('editor')} className={`w-14 h-14 rounded-full flex items-center justify-center transition-all duration-300 ${view === 'editor' ? 'bg-white text-black scale-105' : 'text-zinc-500 hover:text-white'}`}><Icon name="layer-group" className="text-lg"/></button>
                            <div className="relative mx-2">
                                <input type="file" multiple accept="image/*" className="hidden" ref={fileInputRef} onChange={handleFile} />
                                <button onClick={() => { if(isOverflow) { alert("Halaman Penuh!"); } else { fileInputRef.current.click(); } }} className={`w-16 h-16 rounded-[2rem] bg-gradient-to-tr ${isOverflow ? 'from-red-600 to-red-500' : 'from-violet-600 to-indigo-600'} text-white flex items-center justify-center shadow-lg transform active:scale-95 transition-all border-[3px] border-[#050505] hover:scale-105`}><Icon name={isOverflow ? "ban" : "plus"} className="text-2xl" /></button>
                            </div>
                            <button onClick={() => setView('preview')} className={`w-14 h-14 rounded-full flex items-center justify-center transition-all duration-300 ${view === 'preview' ? 'bg-white text-black scale-105' : 'text-zinc-500 hover:text-white'}`}><Icon name="file-pdf" className="text-lg"/></button>
                            <button onClick={() => setView('settings')} className={`w-14 h-14 rounded-full flex items-center justify-center transition-all duration-300 ${view === 'settings' ? 'bg-white text-black scale-105' : 'text-zinc-500 hover:text-white'}`}><Icon name="cog" className="text-lg"/></button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
